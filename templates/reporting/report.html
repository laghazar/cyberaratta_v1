
{% extends 'base.html' %}
{% load static %}

{% block title %}
‘∂’•’≤’Æ’°÷Ä’°÷Ä’∏÷Ç’©’µ’°’∂ ’§’•’∫÷Ñ’•÷Ä’´ ’§’´’¥’∏÷Ç’¥
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reporting.css' %}?v=2025{{ request.GET.v|default:'1' }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Select2 CSS - Local -->
<link href="{% static 'css/select2/select2.min.css' %}?v=2025{{ request.GET.v|default:'1' }}" rel="stylesheet" />
<style>
    /* Custom Select2 dark theme - FORCE OVERRIDE */
    .select2-container--default .select2-selection--single {
        background-color: #2a2a2a !important;
        border: 2px solid #00a99d !important;
        color: #ffffff !important;
        border-radius: 8px !important;
        height: 50px !important;
        padding: 8px 12px !important;
        font-size: 16px !important;
        box-shadow: none !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #ffffff !important;
        line-height: 32px !important;
        padding-left: 8px !important;
        font-size: 16px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: rgba(255, 255, 255, 0.6) !important;
        font-size: 16px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        top: 15px !important;
        right: 12px !important;
        width: 20px !important;
        height: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #ffffff transparent transparent transparent !important;
        border-style: solid !important;
        border-width: 6px 4px 0 4px !important;
    }
    
    .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
        border-color: transparent transparent #ffffff transparent !important;
        border-width: 0 4px 6px 4px !important;
    }
    
    .select2-dropdown {
        background-color: #2a2a2a !important;
        border: 2px solid #00a99d !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 169, 157, 0.3) !important;
    }
    
    .select2-container--default .select2-results__option {
        background-color: #2a2a2a !important;
        color: #ffffff !important;
        padding: 12px 16px !important;
        font-size: 16px !important;
        border-bottom: 1px solid rgba(0, 169, 157, 0.2) !important;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #00a99d !important;
        color: #ffffff !important;
    }
    
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #00d4c4 !important;
        color: #000000 !important;
        font-weight: bold !important;
    }
    
    .select2-container--default .select2-search--dropdown .select2-search__field {
        background-color: #1a1a1a !important;
        border: 1px solid #00a99d !important;
        color: #ffffff !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
        font-size: 16px !important;
    }
    
    .select2-container {
        width: 100% !important;
        z-index: 9999 !important;
        font-family: inherit !important;
    }
    
    /* Hide default Bootstrap select styling */
    #id_platform_source.form-select {
        display: none !important;
    }
    
    /* Force Select2 to be visible */
    .select2-container .select2-selection--single {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure proper stacking */
    .select2-dropdown {
        z-index: 10000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="reporting-container">
    <div class="container">
        <!-- Header Section -->
        <div class="reporting-header">
            <h1>‘∂’•’≤’Æ’°÷Ä’°÷Ä’∏÷Ç’©’µ’°’∂ ’§’•’¥ ’∫’°’µ÷Ñ’°÷Ä</h1>
            <p class="lead text-white-50">‘º÷Ä’°÷Å÷Ä’•÷Ñ ’§’´’¥’∏÷Ç’¥’®, ’Ø’´’Ω’æ’•÷Ñ ’±’•’¶ ’∞’°’∂’§’´’∫’°’Æ ’§’•’∫÷Ñ’•÷Ä’∏’æ, ÷Ö’£’∂’•÷Ñ ’°’µ’¨ ’¥’°÷Ä’§’Ø’°’∂÷Å</p>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success safe' or message.tags == 'success' %}alert-custom{% elif message.tags == 'error safe' or message.tags == 'error' %}alert-error{% endif %} alert-dismissible fade show" role="alert">
                    {% if 'safe' in message.tags %}
                        {{ message|safe }}
                    {% else %}
                        {{ message }}
                    {% endif %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="’ì’°’Ø’•’¨"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row g-4">
            <!-- Left Column - Report Form -->
            <div class="col-lg-7">
                <div class="reporting-form-card card">
                    <div class="card-header">
                        <h4><i class="fas fa-shield-alt me-2"></i>‘¥’´’¥’∏÷Ç’¥’´ ’±÷á</h4>
                        <small class="text-white-50">‘≤’∏’¨’∏÷Ä ’°’∂’∞÷Ä’°’™’•’∑’ø ’§’°’∑’ø’•÷Ä’® ’∂’∑’æ’°’Æ ’•’∂ * ’∂’∑’°’∂’∏’æ</small>
                        <!-- Debug Button for localStorage -->
                        <button type="button" class="btn btn-sm btn-outline-warning float-end" onclick="clearLocalStorageAndReload()" style="font-size: 12px;">
                            üßπ Clear Cache
                        </button>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="reportForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">
                                        {{ form.category.label }}
                                    </label>
                                    {{ form.category }}
                                    {% if form.category.help_text %}
                                        <div class="form-text">{{ form.category.help_text }}</div>
                                    {% endif %}
                                    {% if form.category.errors %}
                                        <div class="text-danger small">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                        
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.help_text %}
                                    <div class="form-text">{{ form.description.help_text }}</div>
                                {% endif %}
                                {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.platform_source.id_for_label }}" class="form-label">
                                    {{ form.platform_source.label }}
                                </label>
                                <div class="position-relative">
                                    {{ form.platform_source }}
                                </div>
                                {% if form.platform_source.help_text %}
                                    <div class="form-text">{{ form.platform_source.help_text }}</div>
                                {% endif %}
                                {% if form.platform_source.errors %}
                                    <div class="text-danger small">{{ form.platform_source.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Other platform source input (hidden by default) -->
                            <div class="mb-3" id="other-platform-div" style="display: none; opacity: 0; transition: all 0.3s ease;">
                                <label for="{{ form.platform_source_other.id_for_label }}" class="form-label">
                                    <i class="fas fa-edit me-1"></i>{{ form.platform_source_other.label }} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-plus text-muted"></i>
                                    </span>
                                    {{ form.platform_source_other }}
                                </div>
                                {% if form.platform_source_other.help_text %}
                                    <div class="form-text">{{ form.platform_source_other.help_text }}</div>
                                {% endif %}
                                {% if form.platform_source_other.errors %}
                                    <div class="text-danger small">{{ form.platform_source_other.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.suspicious_url.id_for_label }}" class="form-label">
                                        {{ form.suspicious_url.label }}
                                    </label>
                                    {{ form.suspicious_url }}
                                    {% if form.suspicious_url.help_text %}
                                        <div class="form-text">{{ form.suspicious_url.help_text }}</div>
                                    {% endif %}
                                    {% if form.suspicious_url.errors %}
                                        <div class="text-danger small">{{ form.suspicious_url.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.suspicious_email.id_for_label }}" class="form-label">
                                        {{ form.suspicious_email.label }}
                                    </label>
                                    {{ form.suspicious_email }}
                                    {% if form.suspicious_email.help_text %}
                                        <div class="form-text">{{ form.suspicious_email.help_text }}</div>
                                    {% endif %}
                                    {% if form.suspicious_email.errors %}
                                        <div class="text-danger small">{{ form.suspicious_email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.contact_info.id_for_label }}" class="form-label">
                                    {{ form.contact_info.label }}
                                </label>
                                {{ form.contact_info }}
                                {% if form.contact_info.help_text %}
                                    <div class="form-text">{{ form.contact_info.help_text }}</div>
                                {% endif %}
                                {% if form.contact_info.errors %}
                                    <div class="text-danger small">{{ form.contact_info.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Has Damage Checkbox -->
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.has_damage }}
                                    <label class="form-check-label" for="{{ form.has_damage.id_for_label }}">
                                        {{ form.has_damage.label }}
                                    </label>
                                </div>
                                {% if form.has_damage.help_text %}
                                    <div class="form-text">{{ form.has_damage.help_text }}</div>
                                {% endif %}
                                {% if form.has_damage.errors %}
                                    <div class="text-danger small">{{ form.has_damage.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Damage Types Field (hidden by default) -->
                            <div class="mb-3" id="damage-types-section" style="display: none;">
                                <label for="{{ form.damage_types.id_for_label }}" class="form-label">
                                    {{ form.damage_types.label }}
                                </label>
                                <div class="damage-types-dropdown-container">
                                    <!-- Overlay for dropdown -->
                                    <div class="dropdown-overlay" id="dropdownOverlay"></div>
                                    <!-- Custom dropdown for damage types -->
                                    <div class="damage-types-custom-dropdown" id="damageTypesDropdown">
                                        <div class="dropdown-header" id="damageTypesHeader">
                                            <span class="dropdown-placeholder">‘∏’∂’ø÷Ä’•’¨ ’æ’∂’°’Ω’´ ’ø’•’Ω’°’Ø’∂’•÷Ä’®</span>
                                            <span class="dropdown-selected" id="selectedDamageTypes" style="display: none;"></span>
                                            <i class="dropdown-arrow fas fa-chevron-down"></i>
                                        </div>
                                        <div class="dropdown-content" id="damageTypesContent" style="display: none;">
                                            <!-- Categories with checkboxes will be loaded here -->
                                        </div>
                                    </div>
                                    <!-- Hidden original field -->
                                    <div style="display: none;">
                                        {{ form.damage_types }}
                                    </div>
                                </div>
                                {% if form.damage_types.help_text %}
                                    <div class="form-text">{{ form.damage_types.help_text }}</div>
                                {% endif %}
                                {% if form.damage_types.errors %}
                                    <div class="text-danger small">{{ form.damage_types.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Damage Details Field (hidden by default) -->
                            <div class="mb-3" id="damage-details-section" style="display: none;">
                                <label for="{{ form.damage_details.id_for_label }}" class="form-label">
                                    {{ form.damage_details.label }}
                                </label>
                                {{ form.damage_details }}
                                {% if form.damage_details.help_text %}
                                    <div class="form-text">{{ form.damage_details.help_text }}</div>
                                {% endif %}
                                {% if form.damage_details.errors %}
                                    <div class="text-danger small">{{ form.damage_details.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
            <!-- Evidence Files Section -->
            <div class="evidence-section mb-4">
                <h5 class="evidence-title mb-3">
                    <i class="fas fa-paperclip me-2"></i>‘±’∫’°÷Å’∏÷Ç’µ÷Å’∂’•÷Ä (’∏’π ’∫’°÷Ä’ø’°’§’´÷Ä)
                </h5>
                <p class="evidence-description">
                    ‘ø’°÷Ä’∏’≤ ’•÷Ñ ’Ø÷Å’•’¨ ’°’∫’°÷Å’∏÷Ç’µ÷Å’∂’•÷Ä’ù ’∂’Ø’°÷Ä’∂’•÷Ä, ÷É’°’Ω’ø’°’©’≤’©’•÷Ä, ’æ’´’§’•’∏ ’Ø’°’¥ ’±’°’µ’∂’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä, ’∏÷Ä’∏’∂÷Ñ ’Ø÷Ö’£’∂’•’∂ ’°’æ’•’¨’´ ’¨’°’æ ’∞’°’Ω’Ø’°’∂’°’¨ ’§’•’∫÷Ñ’®:
                </p>
                
                <!-- Universal File Upload Section -->
                <div class="universal-file-upload mt-4">
                    <div class="upload-area" id="universalFileUpload">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h5 class="upload-title">‘ø÷Å’•’¨ ÷Ü’°’µ’¨</h5>
                            <p class="upload-description">
                                ’î’°’∑’•÷Ñ ÷á ’£÷Å’•÷Ñ ÷Ü’°’µ’¨’•÷Ä’® ’°’µ’Ω’ø’•’≤ ’Ø’°’¥ ’Ω’•’≤’¥’•÷Ñ ’®’∂’ø÷Ä’•’¨’∏÷Ç ’∞’°’¥’°÷Ä
                            </p>
                            <div class="file-types">
                                <span class="file-type-badge">’Ü’Ø’°÷Ä’∂’•÷Ä</span>
                                <span class="file-type-badge">’ì’°’Ω’ø’°’©’≤’©’•÷Ä</span>
                                <span class="file-type-badge">’é’´’§’•’∏</span>
                                <span class="file-type-badge">’Å’°’µ’∂</span>
                            </div>
                        </div>
                        <input type="file" id="universalFileInput" name="evidence_files_multiple" 
                               accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff,.pdf,.doc,.docx,.txt,.rtf,.odt,.mp4,.avi,.mov,.wmv,.flv,.webm,.mkv,.mp3,.wav,.ogg,.m4a,.aac,.flac,.zip,.rar,.7z"
                               multiple style="display: none;">
                    </div>
                    
                    <!-- File List -->
                    <div class="uploaded-files-list" id="uploadedFilesList" style="display: none;">
                        <h6 class="files-list-title">‘∏’∂’ø÷Ä’æ’°’Æ ÷Ü’°’µ’¨’•÷Ä</h6>
                        <div class="files-container" id="filesContainer"></div>
                        <div class="total-size-info" id="totalSizeInfo">
                            <span class="total-size">‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’Æ’°’æ’°’¨: <span id="totalSizeValue">0 MB</span></span>
                            <span class="max-size">‘±’º’°’æ’•’¨’°’£’∏÷Ç’µ’∂: 100 MB</span>
                        </div>
                    </div>
                </div>
            </div>                            {% if form.non_field_errors %}
                                <div class="alert alert-error">
                                    {{ form.non_field_errors.0 }}
                                </div>
                            {% endif %}
                            
                            <button type="submit" class="btn btn-submit-report w-100">
                                <i class="fas fa-paper-plane me-2"></i>’à÷Ç’≤’°÷Ä’Ø’•’¨ ’¶’•’Ø’∏÷Ç÷Å’∏÷Ç’¥’®
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column - Contact Information -->
            <div class="col-lg-5">
                <div class="contacts-section">
                    <div class="contacts-header">
                        <h4><i class="fas fa-phone-alt me-2"></i>’à÷Ç’¥ ’§’´’¥’•’¨</h4>
                        <small class="text-white-50">‘±÷Ä’ø’°’Ø’°÷Ä’£ ’´÷Ä’°’æ’´’≥’°’Ø’∂’•÷Ä’´ ÷á ’¨÷Ä’°÷Å’∏÷Ç÷Å’´’π ÷Ö’£’∂’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä</small>
                    </div>
                    <div class="p-3">
                        {% if contacts %}
                            <div class="row row-cols-1 g-3">
                                {% for contact in contacts %}
                                <div class="col">
                                    <div class="contact-card card">
                                        <div class="card-body">
                                            {% if contact.is_emergency %}
                                                <div class="emergency-badge">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>‘±÷Ä’ø’°’Ø’°÷Ä’£
                                                </div>
                                            {% endif %}
                                            <h5 class="contact-title">{{ contact.name }}</h5>
                                            {% if contact.description %}
                                                <p class="contact-desc">{{ contact.description }}</p>
                                            {% endif %}
                                            
                                            <!-- Contact Guidelines -->
                                            {% if contact.guideline %}
                                            <div class="guideline-section mb-3">
                                                <h6 class="text-info"><i class="fas fa-info-circle me-1"></i>‘¥’´’¥’•’¨’∏÷Ç ’∏÷Ç’≤’•÷Å’∏÷Ç’µ÷Å</h6>
                                                
                                                {% if contact.guideline.when_to_contact %}
                                                <div class="guideline-item">
                                                    <strong class="text-warning">‘µ÷Ä’¢ ’§’´’¥’•’¨:</strong>
                                                    <p class="small text-white-50">{{ contact.guideline.when_to_contact }}</p>
                                                </div>
                                                {% endif %}
                                                
                                                {% if contact.guideline.required_documents %}
                                                <div class="guideline-item">
                                                    <strong class="text-warning">‘±’∂’∞÷Ä’°’™’•’∑’ø ÷É’°’Ω’ø’°’©’≤’©’•÷Ä:</strong>
                                                    <p class="small text-white-50">{{ contact.guideline.required_documents }}</p>
                                                </div>
                                                {% endif %}
                                                
                                                {% if contact.guideline.response_time %}
                                                <div class="guideline-item">
                                                    <strong class="text-warning">’ä’°’ø’°’Ω’≠’°’∂’´ ’™’°’¥’Ø’•’ø:</strong>
                                                    <span class="badge bg-info">{{ contact.guideline.response_time }}</span>
                                                </div>
                                                {% endif %}
                                                
                                                {% if contact.guideline.additional_info %}
                                                <div class="guideline-item">
                                                    <strong class="text-warning">‘º÷Ä’°÷Å’∏÷Ç÷Å’´’π ’ø’•’≤’•’Ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä:</strong>
                                                    <p class="small text-white-50">{{ contact.guideline.additional_info }}</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% if contact.phone %}
                                                <div class="contact-info">
                                                    <strong><i class="fas fa-phone me-1"></i>’Ä’•’º’°’≠’∏’Ω:</strong> 
                                                    <a href="tel:{{ contact.phone }}">{{ contact.phone }}</a>
                                                </div>
                                            {% endif %}
                                            {% if contact.email %}
                                                <div class="contact-info">
                                                    <strong><i class="fas fa-envelope me-1"></i>‘∑’¨. ÷É’∏’Ω’ø:</strong> 
                                                    <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                                                </div>
                                            {% endif %}
                                            {% if contact.website %}
                                                <div class="contact-info">
                                                    <strong><i class="fas fa-globe me-1"></i>‘ø’°’µ÷Ñ:</strong> 
                                                    <a href="{{ contact.website }}" target="_blank" rel="noopener">{{ contact.website }}</a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-white-50 py-4">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p>‘ø’∏’∂’ø’°’Ø’ø’°’µ’´’∂ ’ø’•’≤’•’Ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä ’π’•’∂ ’£’ø’∂’æ’•’¨</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Category Statistics -->
                {% if category_stats %}
                <div class="contacts-section mt-4">
                    <div class="contacts-header">
                        <h4><i class="fas fa-chart-pie me-2"></i>‘ø’°’ø’•’£’∏÷Ä’´’°’∂’•÷Ä ’®’Ω’ø ’¶’•’Ø’∏÷Ç÷Å’∏÷Ç’¥’∂’•÷Ä’´</h4>
                    </div>
                    <div class="p-3">
                        {% for stat in category_stats %}
                        <div class="d-flex justify-content-between align-items-center mb-2 category-{{ stat.category }}">
                            <span class="text-white">{{ stat.category|title }}</span>
                            <span class="badge bg-primary">{{ stat.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JavaScript - Local -->
<script src="{% static 'js/select2/select2.min.js' %}?v=2025{{ request.GET.v|default:'1' }}"></script>

<script>
// Clear localStorage for fresh start
console.log('üßπ CLEARING localStorage for fresh start...');
const draftKeys = Object.keys(localStorage).filter(key => 
    key.includes('report') || key.includes('draft') || key.includes('platform')
);
console.log('üßπ Found draft keys:', draftKeys);
draftKeys.forEach(key => {
    console.log('üßπ Removing key:', key);
    localStorage.removeItem(key);
});

$(document).ready(function() {
    console.log('üîß ULTIMATE DEBUG: Document ready fired');
    console.log('üîß ULTIMATE DEBUG: jQuery version:', $.fn.jquery);
    console.log('üîß ULTIMATE DEBUG: Select2 available:', typeof $.fn.select2);
    console.log('üîß ULTIMATE DEBUG: Page URL:', window.location.href);
    
    // Check ALL select elements
    console.log('üîß ULTIMATE DEBUG: All select elements count:', $('select').length);
    $('select').each(function(index) {
        console.log('üîß ULTIMATE DEBUG: Select element', index, ':', this.id, this.className);
    });
    
    // Check if element exists
    const platformElement = $('#id_platform_source');
    console.log('üîß ULTIMATE DEBUG: Platform element found:', platformElement.length);
    console.log('üîß ULTIMATE DEBUG: Platform element:', platformElement[0]);
    
    if (platformElement.length > 0) {
        console.log('üîß ULTIMATE DEBUG: Element classes:', platformElement[0].className);
        console.log('üîß ULTIMATE DEBUG: Element attributes:', platformElement[0].attributes);
        console.log('üîß ULTIMATE DEBUG: Element options count:', platformElement.find('option').length);
        console.log('üîß ULTIMATE DEBUG: First 3 options:', platformElement.find('option').slice(0, 3).map(function() { return $(this).text(); }).get());
        
        // Reset element value to ensure clean state
        platformElement.val('').trigger('change');
        console.log('üîß ULTIMATE DEBUG: Reset element value to empty');
    }
    
    if (platformElement.length === 0) {
        console.error('‚ùå ULTIMATE ERROR: Platform select element not found!');
        console.log('üîß ULTIMATE DEBUG: Looking for alternative selectors...');
        console.log('üîß ULTIMATE DEBUG: .select2-platform elements:', $('.select2-platform').length);
        console.log('üîß ULTIMATE DEBUG: .form-select elements:', $('.form-select').length);
        console.log('üîß ULTIMATE DEBUG: [name="platform_source"] elements:', $('[name="platform_source"]').length);
        return;
    }
    
    if (typeof $.fn.select2 === 'undefined') {
        console.error('‚ùå ULTIMATE ERROR: Select2 library not loaded!');
        console.log('üîß ULTIMATE DEBUG: Available jQuery plugins:', Object.keys($.fn).slice(0, 10));
        return;
    }
    
    // Form submission handling
    const form = document.getElementById('reportForm');
    const submitButton = form.querySelector('button[type="submit"]');
    
    form.addEventListener('submit', function() {
        submitButton.classList.add('submitting');
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>’à÷Ç’≤’°÷Ä’Ø’æ’∏÷Ç’¥ ’ß...';
        submitButton.disabled = true;
    });
    
    // Auto-resize textarea
    const textarea = form.querySelector('textarea');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
    
    // Handle damage checkbox functionality
    const hasDamageCheckbox = document.getElementById('id_has_damage');
    const damageTypesSection = document.getElementById('damage-types-section');
    const damageDetailsSection = document.getElementById('damage-details-section');
    
    if (hasDamageCheckbox && damageTypesSection && damageDetailsSection) {
        console.log('üîß DAMAGE DEBUG: Setting up damage checkbox functionality');
        
        function toggleDamageSections() {
            const isChecked = hasDamageCheckbox.checked;
            console.log('üîß DAMAGE DEBUG: Checkbox checked:', isChecked);
            
            if (isChecked) {
                damageTypesSection.style.display = 'block';
                damageDetailsSection.style.display = 'block';
                setTimeout(() => {
                    damageTypesSection.style.opacity = '1';
                    damageDetailsSection.style.opacity = '1';
                }, 10);
            } else {
                damageTypesSection.style.opacity = '0';
                damageDetailsSection.style.opacity = '0';
                setTimeout(() => {
                    damageTypesSection.style.display = 'none';
                    damageDetailsSection.style.display = 'none';
                }, 300);
                
                // Clear all damage type selections when unchecked
                const damageTypesSelect = $('#id_damage_types');
                if (damageTypesSelect.length > 0) {
                    // Clear Select2 selection
                    damageTypesSelect.val(null).trigger('change');
                }
                
                // Clear damage details textarea
                const damageDetailsTextarea = damageDetailsSection.querySelector('textarea');
                if (damageDetailsTextarea) {
                    damageDetailsTextarea.value = '';
                }
            }
        }
        
        // Set initial state
        toggleDamageSections();
        
        // Add event listener
        hasDamageCheckbox.addEventListener('change', toggleDamageSections);
    }
    
    // Initialize Select2 for platform dropdown with delay
    setTimeout(function() {
        try {
            console.log('üîß ULTIMATE DEBUG: Attempting Select2 initialization with delay...');
            console.log('üîß ULTIMATE DEBUG: Element before init:', platformElement[0]);
            
            // Ensure element is clean before initialization
            if (platformElement.hasClass('select2-hidden-accessible')) {
                console.log('üîß ULTIMATE DEBUG: Destroying existing Select2...');
                platformElement.select2('destroy');
            }
            
            const select2Options = {
                placeholder: '‘∏’∂’ø÷Ä’•’¨ ’°’≤’¢’µ’∏÷Ç÷Ä’®',
                allowClear: true,
                width: '100%',
                minimumResultsForSearch: 5,
                dropdownParent: $('body'), // Try using body as parent
                theme: 'default'
            };
            
            console.log('üîß ULTIMATE DEBUG: Select2 options:', select2Options);
            
            platformElement.select2(select2Options);
            
            console.log('‚úÖ ULTIMATE SUCCESS: Platform Select2 initialized successfully');
            console.log('üîß ULTIMATE DEBUG: Element after init:', platformElement[0]);
            console.log('üîß ULTIMATE DEBUG: Select2 container:', $('.select2-container').length);
            
            // Initialize Custom Damage Types Dropdown instead of Select2
            const damageTypesElement = $('#id_damage_types');
            console.log('üîß DAMAGE DEBUG: Starting custom damage types dropdown initialization...');
            
            if (damageTypesElement.length > 0) {
                try {
                    // Destroy existing Select2 if present
                    if (damageTypesElement.hasClass('select2-hidden-accessible')) {
                        console.log('üîß DAMAGE DEBUG: Destroying existing damage types Select2...');
                        damageTypesElement.select2('destroy');
                    }
                    
                    // Initialize custom dropdown
                    initializeCustomDamageTypesDropdown();
                    console.log('‚úÖ DAMAGE SUCCESS: Custom Damage Types dropdown initialized successfully');
                    
                } catch (damageError) {
                    console.error('‚ùå DAMAGE ERROR: Custom Damage Types dropdown initialization failed:', damageError);
                }
            } else {
                console.log('‚ö†Ô∏è DAMAGE WARNING: Damage types element not found');
            }
            
            // Force trigger to ensure it's working
            setTimeout(function() {
                console.log('üîß ULTIMATE DEBUG: Testing dropdown functionality...');
                const hasClass = platformElement.hasClass('select2-hidden-accessible');
                console.log('üîß ULTIMATE DEBUG: Has Select2 class:', hasClass);
                
                if (hasClass) {
                    console.log('üéâ ULTIMATE SUCCESS: Select2 dropdown is working!');
                } else {
                    console.log('‚ö†Ô∏è ULTIMATE WARNING: Select2 class not detected, but trying...');
                }
            }, 500);
            
        } catch (error) {
            console.error('‚ùå ULTIMATE ERROR: Select2 initialization failed:', error);
            console.error('‚ùå ULTIMATE ERROR: Error details:', error.message);
            console.error('‚ùå ULTIMATE ERROR: Stack trace:', error.stack);
            
            // Try to apply basic styling as fallback
            platformElement.css({
                'background-color': '#2a2a2a',
                'border': '2px solid #00a99d',
                'color': '#ffffff',
                'border-radius': '8px',
                'padding': '10px',
                'font-size': '16px',
                'height': '50px'
            });
        }
    }, 1000); // 1 second delay
    
    // Handle "‘±’µ’¨" selection for showing/hiding manual input
    $('#id_platform_source').on('select2:select', function (e) {
        console.log('üîß ULTIMATE DEBUG: Select2 select event fired');
        var data = e.params.data;
        const otherPlatformDiv = document.getElementById('other-platform-div');
        const otherPlatformInput = document.getElementById('id_platform_source_other');
        
        if (data.text === '‘±’µ’¨') {
            if (otherPlatformDiv && otherPlatformInput) {
                otherPlatformDiv.style.display = 'block';
                setTimeout(() => {
                    otherPlatformDiv.style.opacity = '1';
                }, 10);
                otherPlatformInput.required = true;
                otherPlatformInput.focus();
            }
        } else {
            if (otherPlatformDiv && otherPlatformInput) {
                otherPlatformDiv.style.opacity = '0';
                setTimeout(() => {
                    otherPlatformDiv.style.display = 'none';
                }, 300);
                otherPlatformInput.required = false;
                otherPlatformInput.value = '';
            }
        }
    });
    
    // Handle clearing selection
    $('#id_platform_source').on('select2:clear', function (e) {
        const otherPlatformDiv = document.getElementById('other-platform-div');
        const otherPlatformInput = document.getElementById('id_platform_source_other');
        
        if (otherPlatformDiv && otherPlatformInput) {
            otherPlatformDiv.style.display = 'none';
            otherPlatformInput.required = false;
            otherPlatformInput.value = '';
        }
    });
    
    // Handle regular dropdown change for non-Select2 fallback
    $('#id_platform_source').change(function() {
        console.log('üîß ULTIMATE DEBUG: Regular change event fired');
        const selectedText = this.options[this.selectedIndex].text;
        const otherPlatformDiv = document.getElementById('other-platform-div');
        const otherPlatformInput = document.getElementById('id_platform_source_other');
        
        if (selectedText === '‘±’µ’¨') {
            if (otherPlatformDiv && otherPlatformInput) {
                otherPlatformDiv.style.display = 'block';
                setTimeout(() => {
                    otherPlatformDiv.style.opacity = '1';
                }, 10);
                otherPlatformInput.required = true;
                otherPlatformInput.focus();
            }
        } else {
            if (otherPlatformDiv && otherPlatformInput) {
                otherPlatformDiv.style.opacity = '0';
                setTimeout(() => {
                    otherPlatformDiv.style.display = 'none';
                }, 300);
                otherPlatformInput.required = false;
                otherPlatformInput.value = '';
            }
        }
    });
    
    // Check initial state on page load
    const initialSelectedText = $('#id_platform_source option:selected').text();
    console.log('üîß ULTIMATE DEBUG: Initial selected text:', initialSelectedText);
    if (initialSelectedText === '‘±’µ’¨') {
        const otherPlatformDiv = document.getElementById('other-platform-div');
        const otherPlatformInput = document.getElementById('id_platform_source_other');
        if (otherPlatformDiv && otherPlatformInput) {
            otherPlatformDiv.style.display = 'block';
            otherPlatformInput.required = true;
        }
    }
    
    // Final verification with more detailed checking
    setTimeout(function() {
        console.log('üîß ULTIMATE DEBUG: 3-second verification check...');
        const hasSelect2 = $('#id_platform_source').hasClass('select2-hidden-accessible');
        const containerCount = $('.select2-container').length;
        const selectCount = $('select').length;
        
        console.log('üîß ULTIMATE DEBUG: Select2 applied:', hasSelect2);
        console.log('üîß ULTIMATE DEBUG: Select2 containers:', containerCount);
        console.log('üîß ULTIMATE DEBUG: Total select elements:', selectCount);
        console.log('üîß ULTIMATE DEBUG: Platform element visible:', platformElement.is(':visible'));
        console.log('üîß ULTIMATE DEBUG: Platform element CSS display:', platformElement.css('display'));
        
        // Log all elements with select2 classes
        $('.select2-container').each(function(index) {
            console.log('üîß ULTIMATE DEBUG: Select2 container', index, ':', this);
        });
        
        if (!hasSelect2) {
            console.error('‚ùå ULTIMATE CRITICAL: Select2 not applied after 3 seconds!');
            console.log('üîß ULTIMATE DEBUG: Final element state:', platformElement[0]);
            console.log('üîß ULTIMATE DEBUG: Final element HTML:', platformElement[0].outerHTML);
        } else {
            console.log('‚úÖ ULTIMATE SUCCESS: Select2 working correctly');
            console.log('üîß ULTIMATE DEBUG: Select2 container HTML:', $('.select2-container')[0].outerHTML);
        }
    }, 3000);
});

// Function to clear localStorage and reload
function clearLocalStorageAndReload() {
    console.log('üßπ Manual localStorage clear requested');
    const allKeys = Object.keys(localStorage);
    console.log('üßπ All localStorage keys:', allKeys);
    localStorage.clear();
    console.log('üßπ localStorage cleared, reloading page...');
    location.reload();
}

// Custom Damage Types Dropdown Function
function initializeCustomDamageTypesDropdown() {
    const originalSelect = document.getElementById('id_damage_types');
    const dropdownContainer = document.getElementById('damageTypesDropdown');
    const dropdownHeader = document.getElementById('damageTypesHeader');
    const dropdownContent = document.getElementById('damageTypesContent');
    const selectedContainer = document.getElementById('selectedDamageTypes');
    const placeholder = dropdownContainer.querySelector('.dropdown-placeholder');
    
    if (!originalSelect || !dropdownContainer) {
        console.error('Required elements not found for custom dropdown');
        return;
    }
    
    // Fetch damage types from API
    fetch('{% url "reporting:damage_types_api" %}')
        .then(response => response.json())
        .then(data => {
            buildDropdownContent(data.categories);
            setupDropdownEvents();
        })
        .catch(error => {
            console.error('Error fetching damage types:', error);
            // Fallback to original select parsing
            buildDropdownFromOriginalSelect();
            setupDropdownEvents();
        });
    
    function buildDropdownContent(categories) {
        let contentHTML = '';
        
        Object.keys(categories).forEach(categoryKey => {
            const category = categories[categoryKey];
            if (category.items && category.items.length > 0) {
                contentHTML += `
                    <div class="damage-category">
                        <div class="category-header">${category.name}</div>
                        <div class="category-items">
                `;
                
                category.items.forEach(item => {
                    contentHTML += `
                        <div class="damage-type-item" data-value="${item.id}">
                            <input type="checkbox" id="damage_${item.id}" value="${item.id}">
                            <label for="damage_${item.id}" title="${item.description || item.name}">${item.name}</label>
                        </div>
                    `;
                });
                
                contentHTML += `
                        </div>
                    </div>
                `;
            }
        });
        
        dropdownContent.innerHTML = contentHTML;
    }
    
    function buildDropdownFromOriginalSelect() {
        // Fallback method - parse from original select
        let contentHTML = `
            <div class="damage-category">
                <div class="category-header">’é’∂’°’Ω’´ ’ø’•’Ω’°’Ø’∂’•÷Ä</div>
                <div class="category-items">
        `;
        
        Array.from(originalSelect.options).forEach(option => {
            if (option.value) {
                contentHTML += `
                    <div class="damage-type-item" data-value="${option.value}">
                        <input type="checkbox" id="damage_${option.value}" value="${option.value}">
                        <label for="damage_${option.value}">${option.text}</label>
                    </div>
                `;
            }
        });
        
        contentHTML += `
                </div>
            </div>
        `;
        
        dropdownContent.innerHTML = contentHTML;
    }
    
    function setupDropdownEvents() {
        const overlay = document.getElementById('dropdownOverlay');
        
        // Toggle dropdown
        dropdownHeader.addEventListener('click', function() {
            const isOpen = dropdownContainer.classList.contains('open');
            if (isOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });
        
        function openDropdown() {
            const dropdownContent = document.getElementById('damageTypesContent');
            
            // Show dropdown with smooth animation
            dropdownContent.style.display = 'block';
            
            // Use requestAnimationFrame for smooth animation
            requestAnimationFrame(() => {
                dropdownContent.classList.add('show');
                dropdownContainer.classList.add('open');
            });
        }
        
        function closeDropdown() {
            const dropdownContent = document.getElementById('damageTypesContent');
            
            dropdownContent.classList.remove('show');
            dropdownContainer.classList.remove('open');
            
            // Hide after animation completes
            setTimeout(() => {
                if (!dropdownContent.classList.contains('show')) {
                    dropdownContent.style.display = 'none';
                }
            }, 300);
        }
        
        // Handle checkbox changes
        dropdownContent.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                updateSelectedValues();
                updateOriginalSelect();
            }
        });
        
        // Close dropdown when clicking overlay
        overlay.addEventListener('click', function() {
            closeDropdown();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownContainer.contains(e.target) && !overlay.contains(e.target)) {
                closeDropdown();
            }
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && dropdownContainer.classList.contains('open')) {
                closeDropdown();
            }
        });
    }
    
    function updateSelectedValues() {
        const selectedCheckboxes = dropdownContent.querySelectorAll('input[type="checkbox"]:checked');
        const selectedValues = Array.from(selectedCheckboxes);
        
        if (selectedValues.length === 0) {
            selectedContainer.style.display = 'none';
            placeholder.style.display = 'block';
        } else {
            selectedContainer.style.display = 'flex';
            placeholder.style.display = 'none';
            
            let badgesHTML = '';
            selectedValues.forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent;
                const shortLabel = label.length > 20 ? label.substring(0, 20) + '...' : label;
                badgesHTML += `
                    <span class="selected-badge" data-value="${checkbox.value}" title="${label}">
                        ${shortLabel}
                        <span class="remove-badge" data-value="${checkbox.value}">√ó</span>
                    </span>
                `;
            });
            selectedContainer.innerHTML = badgesHTML;
        }
        
        // Add event listeners to remove badges
        selectedContainer.querySelectorAll('.remove-badge').forEach(badge => {
            badge.addEventListener('click', function(e) {
                e.stopPropagation();
                const value = this.getAttribute('data-value');
                const checkbox = dropdownContent.querySelector(`input[value="${value}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    updateSelectedValues();
                    updateOriginalSelect();
                }
            });
        });
    }
    
    function updateOriginalSelect() {
        const selectedCheckboxes = dropdownContent.querySelectorAll('input[type="checkbox"]:checked');
        const selectedValues = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        // Clear all selections in original select
        Array.from(originalSelect.options).forEach(option => {
            option.selected = false;
        });
        
        // Set selected values in original select
        selectedValues.forEach(value => {
            const option = originalSelect.querySelector(`option[value="${value}"]`);
            if (option) {
                option.selected = true;
            }
        });
        
        // Trigger change event on original select
        originalSelect.dispatchEvent(new Event('change'));
    }
    
    // Universal File Upload Handler
    function setupUniversalFileUpload() {
        const uploadArea = document.getElementById('universalFileUpload');
        const fileInput = document.getElementById('universalFileInput');
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const filesContainer = document.getElementById('filesContainer');
        const totalSizeValue = document.getElementById('totalSizeValue');
        
        let selectedFiles = [];
        const maxTotalSize = 100 * 1024 * 1024; // 100MB
        const maxFileSizes = {
            image: 5 * 1024 * 1024,    // 5MB for images
            document: 10 * 1024 * 1024, // 10MB for documents
            video: 50 * 1024 * 1024,   // 50MB for videos
            audio: 15 * 1024 * 1024,   // 15MB for audio
            archive: 25 * 1024 * 1024  // 25MB for archives
        };
        
        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleFiles(files) {
            const fileArray = Array.from(files);
            
            fileArray.forEach(file => {
                if (validateFile(file)) {
                    selectedFiles.push(file);
                }
            });
            
            updateFilesList();
        }
        
        function validateFile(file) {
            const fileType = getFileType(file.name);
            const maxSize = maxFileSizes[fileType] || 25 * 1024 * 1024;
            
            if (file.size > maxSize) {
                const maxSizeMB = Math.round(maxSize / (1024 * 1024));
                alert(`${file.name} ÷Ü’°’µ’¨’´ ’π’°÷É’® ’π’∫’•’ø÷Ñ ’ß ’£’•÷Ä’°’¶’°’∂÷Å’´ ${maxSizeMB}’Ñ‘≤-’®`);
                return false;
            }
            
            const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0) + file.size;
            if (totalSize > maxTotalSize) {
                alert('‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ÷Ü’°’µ’¨’•÷Ä’´ ’Æ’°’æ’°’¨’® ’π’∫’•’ø÷Ñ ’ß ’£’•÷Ä’°’¶’°’∂÷Å’´ 100’Ñ‘≤-’®');
                return false;
            }
            
            return true;
        }
        
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff'].includes(ext)) {
                return 'image';
            } else if (['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'].includes(ext)) {
                return 'document';
            } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv'].includes(ext)) {
                return 'video';
            } else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'].includes(ext)) {
                return 'audio';
            } else if (['zip', 'rar', '7z'].includes(ext)) {
                return 'archive';
            }
            return 'other';
        }
        
        function getFileIcon(fileType) {
            const icons = {
                image: 'fas fa-image',
                document: 'fas fa-file-alt',
                video: 'fas fa-video',
                audio: 'fas fa-music',
                archive: 'fas fa-file-archive',
                other: 'fas fa-file'
            };
            return icons[fileType] || 'fas fa-file';
        }
        
        function getFileTypeLabel(fileType) {
            const labels = {
                image: '’Ü’Ø’°÷Ä',
                document: '’ì’°’Ω’ø.',
                video: '’é’´’§’•’∏',
                audio: '’Å’°’µ’∂',
                archive: '‘±÷Ä’≠’´’æ',
                other: '’ñ’°’µ’¨'
            };
            return labels[fileType] || '’ñ’°’µ’¨';
        }
        
        function updateFilesList() {
            if (selectedFiles.length === 0) {
                uploadedFilesList.style.display = 'none';
                return;
            }
            
            uploadedFilesList.style.display = 'block';
            
            let html = '';
            selectedFiles.forEach((file, index) => {
                const fileType = getFileType(file.name);
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const icon = getFileIcon(fileType);
                const typeLabel = getFileTypeLabel(fileType);
                
                html += `
                    <div class="file-item" data-index="${index}">
                        <div class="file-item-info">
                            <i class="${icon} file-icon"></i>
                            <div class="file-details">
                                <div class="file-item-name" title="${file.name}">${file.name}</div>
                                <div class="file-item-size">
                                    ${fileSizeMB} MB
                                    <span class="file-item-type">${typeLabel}</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="file-remove" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            filesContainer.innerHTML = html;
            
            // Update total size
            const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            totalSizeValue.textContent = `${totalSizeMB} MB`;
            
            // Add warning classes if approaching limits
            if (totalSize > maxTotalSize * 0.9) {
                totalSizeValue.className = 'size-warning';
            } else if (totalSize > maxTotalSize) {
                totalSizeValue.className = 'size-error';
            } else {
                totalSizeValue.className = '';
            }
        }
        
        // Make removeFile function global
        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            updateFilesList();
        };
    }
    
    // Initialize file upload when page loads
    setupUniversalFileUpload();
}
</script>

<script src="{% static 'js/reporting.js' %}"></script>
{% endblock %}