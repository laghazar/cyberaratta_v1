{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container">
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
    </div>
    <h2 class="mb-4">{{ question.question_text }}</h2>
    {% if question.image %}
    <div class="text-center mb-4">
        <img src="{{ question.image.url }}" alt="Հարցի նկարը" class="img-fluid rounded shadow">
    </div>
    {% endif %}
    <div id="feedback" class="mb-4"></div>
    <form id="answer-form">
        <input type="hidden" id="selected-answer-id" name="answer_id" value="">
        {% for answer in answers %}
        <button type="button" class="btn btn-outline-light answer-choice-btn w-100 text-start mb-3" 
                data-answer-id="{{ answer.id }}" onclick="selectAnswerButton({{ answer.id }})">
            <span class="answer-letter">{{ forloop.counter|get_letter }}</span>. {{ answer.answer_text }}
        </button>
        {% endfor %}
        <button type="submit" class="btn btn-primary mt-3">Հաստատել</button>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Classic quiz page loaded');
    
    // Function to select answer button
    function selectAnswerButton(answerId) {
        console.log('selectAnswerButton called with ID:', answerId);
        
        // Remove active class from all buttons
        document.querySelectorAll('.answer-choice-btn').forEach(btn => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-light');
        });
        
        // Add active class to selected button
        const selectedButton = document.querySelector(`[data-answer-id="${answerId}"]`);
        if (selectedButton) {
            selectedButton.classList.remove('btn-outline-light');
            selectedButton.classList.add('btn-success');
            
            // Set hidden input value
            document.getElementById('selected-answer-id').value = answerId;
            console.log('Answer selected:', answerId);
        } else {
            console.error('Button not found for ID:', answerId);
        }
    }
    
    // Make function global so onclick can access it
    window.selectAnswerButton = selectAnswerButton;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    document.getElementById('answer-form').addEventListener('submit', function(e) {
        console.log('=== FORM SUBMITTED ===');
        e.preventDefault();
        
        const selectedAnswerId = document.getElementById('selected-answer-id').value;
        console.log('Selected answer ID:', selectedAnswerId);
        
        if (!selectedAnswerId) {
            console.error('No answer selected!');
            alert('Խնդրում ենք ընտրել պատասխան');
            return;
        }
        
        // Disable all buttons
        document.querySelectorAll('.answer-choice-btn').forEach(btn => {
            btn.disabled = true;
        });
        document.querySelector('button[type="submit"]').disabled = true;
        
        fetch('{% url "quiz:submit_answer" session.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({answer_id: selectedAnswerId})
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response received:', data);
            
            if (data.redirect === 'result') {
                console.log('Redirecting to result page');
                window.location.href = '{% url "quiz:quiz_result" session.id %}';
            } else {
                const feedbackDiv = document.getElementById('feedback');
                feedbackDiv.innerHTML = `
                    <div class="alert alert-${data.correct ? 'success' : 'danger'}">
                        <h5>${data.correct ? '✓ Ճիշտ է!' : '✗ Սխալ է!'}</h5>
                        <p>${data.explanation}</p>
                        <p class="fw-bold">Ձեռք բերված միավորներ: ${data.points_earned}</p>
                    </div>
                `;
                console.log('Feedback displayed, reloading in 3 seconds');
                setTimeout(() => window.location.reload(), 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h5>Սխալ։</h5>
                    <p>Տեղի է ունեցել սխալ: Խնդրում ենք նորից փորձել:</p>
                </div>
            `;
            // Re-enable buttons on error
            document.querySelectorAll('.answer-choice-btn').forEach(btn => {
                btn.disabled = false;
            });
            document.querySelector('button[type="submit"]').disabled = false;
        });
    });
    
    const answerButtons = document.querySelectorAll('.answer-choice-btn');
    console.log('Found answer buttons:', answerButtons.length);
    
    answerButtons.forEach(function(button, index) {
        console.log(`Answer button ${index + 1}:`, button.dataset.answerId);
    });
});
</script>
{% endblock %}