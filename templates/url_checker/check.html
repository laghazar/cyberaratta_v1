{% extends 'base.html' %}

{% block title %}URL ’ç’ø’∏÷Ç’£’´’π - CyberAratta{% endblock %}

{% block page_title %}üîó URL ’ç’ø’∏÷Ç’£’´’π{% endblock %}

{% block page_subtitle %}
<p class="lead text-center mb-5">’ç’ø’∏÷Ç’£’•÷Ñ ’Ø’°’µ÷Ñ’•÷Ä’´ ÷á ’ß’¨. ÷É’∏’Ω’ø’´ ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂’® ’æ’°’µ÷Ä’Ø’µ’°’∂’∂’•÷Ä’´ ’®’∂’©’°÷Å÷Ñ’∏÷Ç’¥</p>
{% endblock %}

{% block extra_head %}
{% load static %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/url_checker.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- URL Checker Section -->
        <div class="col-lg-6 mb-4">
            <div class="cyber-card h-100">
                <div class="cyber-card-header">
                    <h4><i class="fas fa-link me-2"></i>URL ’ç’ø’∏÷Ç’£’´’π</h4>
                    <p class="mb-0" style="color: rgba(255, 255, 255, 0.7);">’ç’ø’∏÷Ç’£’•÷Ñ ’Ø’°’µ÷Ñ’•÷Ä’´ ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂’®</p>
                </div>
                <div class="cyber-card-body">
                    <form method="post" action="{% url 'url_checker:check_url' %}" id="urlCheckForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="url_input" class="form-label">
                                <i class="fas fa-globe me-2"></i>‘ø’°’µ÷Ñ’´ ’Ä’°’Ω÷Å’• (URL)
                            </label>
                            <input type="url" name="input_text" id="url_input" class="form-control" 
                                   placeholder="https://example.com" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                ’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’Ω’ø’∏÷Ç’£’æ’∏’≤ ’Ø’°’µ÷Ñ’´ ’°’¥’¢’∏’≤’ª’°’Ø’°’∂ ’∞’°’Ω÷Å’•’∂
                            </div>
                        </div>
                        
                        <!-- Security Sources Selection -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-shield-alt me-2"></i>‘∏’∂’ø÷Ä’•÷Ñ ‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ‘±’≤’¢’µ’∏÷Ç÷Ä’∂’•÷Ä’®
                            </label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="sourcesDropdown" data-bs-toggle="dropdown" data-bs-auto-close="false" aria-expanded="false">
                                    <span id="selectedSourcesText">VirusTotal, Kaspersky, Google Safe Browsing</span>
                                    <span class="badge bg-primary ms-2" id="selectedCount">3</span>
                                </button>
                                <ul class="dropdown-menu w-100 p-2" aria-labelledby="sourcesDropdown">
                                    <li class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input source-checkbox" type="checkbox" name="sources" value="virustotal" id="vt_dropdown_check" checked>
                                            <label class="form-check-label" for="vt_dropdown_check">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-virus text-primary me-2"></i>
                                                    <div>
                                                        <strong>VirusTotal</strong>
                                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">70+ ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ engine</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input source-checkbox" type="checkbox" name="sources" value="kaspersky" id="kasp_dropdown_check" checked>
                                            <label class="form-check-label" for="kasp_dropdown_check">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-shield-virus text-success me-2"></i>
                                                    <div>
                                                        <strong>Kaspersky OpenTIP</strong>
                                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">‘ø’´’¢’•÷Ä-’Ω’∫’°’º’∂’°’¨’´÷Ñ’∂’•÷Ä’´ ’¢’°’¶’°</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input source-checkbox" type="checkbox" name="sources" value="safebrowsing" id="safe_dropdown_check" checked>
                                            <label class="form-check-label" for="safe_dropdown_check">
                                                <div class="d-flex align-items-center">
                                                    <i class="fab fa-google text-warning me-2"></i>
                                                    <div>
                                                        <strong>Google Safe Browsing</strong>
                                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">Google-’´ ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ’¢’°’¶’°</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input source-checkbox" type="checkbox" name="sources" value="urlvoid" id="void_dropdown_check" disabled>
                                            <label class="form-check-label" for="void_dropdown_check">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-search text-info me-2"></i>
                                                    <div>
                                                        <strong>URLVoid</strong>
                                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">’á’∏÷Ç’ø’∏’æ ’∞’°’Ω’°’∂’•’¨’´</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input source-checkbox" type="checkbox" name="sources" value="abuseipdb" id="abuse_dropdown_check" disabled>
                                            <label class="form-check-label" for="abuse_dropdown_check">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-database text-danger me-2"></i>
                                                    <div>
                                                        <strong>AbuseIPDB</strong>
                                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">’á’∏÷Ç’ø’∏’æ ’∞’°’Ω’°’∂’•’¨’´</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                ‘±’æ’•’¨’´ ’∑’°’ø ’°’≤’¢’µ’∏÷Ç÷Ä = ’°’æ’•’¨’´ ’≥’∑’£÷Ä’´’ø ’°÷Ä’§’µ’∏÷Ç’∂÷Ñ
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-cyber btn-lg w-100">
                                <i class="fas fa-search me-2"></i>‘≥’∂’°’∞’°’ø’•’¨ ‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂’®
                            </button>
                        </div>
                    </form>

                    <div id="urlResult" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Email Checker Section -->
        <div class="col-lg-6 mb-4">
            <div class="cyber-card h-100">
                <div class="cyber-card-header">
                    <h4><i class="fas fa-envelope me-2"></i>‘∑’¨. ÷É’∏’Ω’ø’´ ’ç’ø’∏÷Ç’£’´’π</h4>
                    <p class="mb-0" style="color: rgba(255, 255, 255, 0.7);">’ç’ø’∏÷Ç’£’•÷Ñ ’ß’¨. ÷É’∏’Ω’ø’•÷Ä’´ ÷Ü’´’∑’´’∂’£’°’µ’´’∂ ’∏÷Ç ’æ’ø’°’∂’£’°’æ’∏÷Ä ’¢’∂’∏÷Ç’µ’©’®</p>
                </div>
                <div class="cyber-card-body">
                    <form method="post" id="emailCheckForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="email_input" class="form-label">
                                <i class="fas fa-at me-2"></i>‘∑’¨. ÷É’∏’Ω’ø’´ ’Ä’°’Ω÷Å’•
                            </label>
                            <input type="email" name="email_text" id="email_input" class="form-control" 
                                   placeholder="example@domain.com" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                ’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’Ω’ø’∏÷Ç’£’æ’∏’≤ ’ß’¨. ÷É’∏’Ω’ø’´ ’∞’°’Ω÷Å’•’∂
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-cyber btn-lg w-100">
                                <i class="fas fa-search me-2"></i>’ç’ø’∏÷Ç’£’•’¨ ‘∑’¨. ÷É’∏’Ω’ø’®
                            </button>
                        </div>
                    </form>

                    <div id="emailResult" class="mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-cog me-2"></i>
                            ‘∑’¨. ÷É’∏’Ω’ø’´ ’Ω’ø’∏÷Ç’£’´’π’® ’∑’∏÷Ç’ø’∏’æ ’Ø’¨’´’∂’´ ’∞’°’Ω’°’∂’•’¨’´÷â ’Ñ’•’∂÷Ñ ’°’∑’≠’°’ø’∏÷Ç’¥ ’•’∂÷Ñ ’∂’∏÷Ä ’´’∂’ø’•’£÷Ä’°÷Å’´’°’∂’•÷Ä’´ ’æ÷Ä’°÷â
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Checks Section -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-12">
            <div class="cyber-card">
                <div class="cyber-card-header">
                    <h4><i class="fas fa-history me-2"></i>’é’•÷Ä’ª’´’∂ ’ç’ø’∏÷Ç’£’∏÷Ç’¥’∂’•÷Ä’®</h4>
                </div>
                <div class="cyber-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3" style="color: rgba(255, 255, 255, 0.7);"><i class="fas fa-link me-2"></i>URL ’ç’ø’∏÷Ç’£’∏÷Ç’¥’∂’•÷Ä</h6>
                            <div id="recentUrls" class="text-center" style="color: rgba(255, 255, 255, 0.6);">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>’ç’ø’∏÷Ç’£’•÷Ñ ’°’º’°’ª’´’∂ URL-’® ÷á ’°’µ’∂ ’Ø’∞’°’µ’ø’∂’æ’´ ’°’µ’Ω’ø’•’≤</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3" style="color: rgba(255, 255, 255, 0.7);"><i class="fas fa-envelope me-2"></i>‘∑’¨. ÷É’∏’Ω’ø’´ ’ç’ø’∏÷Ç’£’∏÷Ç’¥’∂’•÷Ä</h6>
                            <div id="recentEmails" class="text-center" style="color: rgba(255, 255, 255, 0.6);">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>‘∑’¨. ÷É’∏’Ω’ø’´ ’Ω’ø’∏÷Ç’£’∏÷Ç’¥’∂’•÷Ä’® ’∑’∏÷Ç’ø’∏’æ ’Ø’¨’´’∂’•’∂ ’∞’°’Ω’°’∂’•’¨’´</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Dropdown checkbox functionality
function updateDropdownText() {
    const checkboxes = document.querySelectorAll('.source-checkbox:checked:not(:disabled)');
    const selectedText = document.getElementById('selectedSourcesText');
    const selectedCount = document.getElementById('selectedCount');
    
    if (checkboxes.length === 0) {
        selectedText.textContent = '‘∏’∂’ø÷Ä’•÷Ñ ’°’≤’¢’µ’∏÷Ç÷Ä’∂’•÷Ä’®...';
        selectedCount.textContent = '0';
        selectedCount.className = 'badge bg-secondary ms-2';
    } else {
        const names = Array.from(checkboxes).map(cb => {
            switch(cb.value) {
                case 'virustotal': return 'VirusTotal';
                case 'kaspersky': return 'Kaspersky';
                case 'safebrowsing': return 'Google Safe Browsing';
                case 'urlvoid': return 'URLVoid';
                case 'abuseipdb': return 'AbuseIPDB';
                default: return cb.value;
            }
        });
        
        if (names.length <= 2) {
            selectedText.textContent = names.join(', ');
        } else {
            selectedText.textContent = names.slice(0, 2).join(', ') + '...';
        }
        
        selectedCount.textContent = checkboxes.length;
        selectedCount.className = 'badge bg-primary ms-2';
    }
}

// Initialize dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing dropdown...');
    
    // Initialize Bootstrap dropdown
    const dropdownElement = document.getElementById('sourcesDropdown');
    const dropdownMenu = dropdownElement?.nextElementSibling;
    
    console.log('Dropdown element:', dropdownElement);
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    
    if (dropdownElement && typeof bootstrap !== 'undefined') {
        try {
            new bootstrap.Dropdown(dropdownElement);
            console.log('Bootstrap dropdown initialized');
        } catch (e) {
            console.error('Bootstrap dropdown failed:', e);
        }
    } 
    
    if (dropdownElement && dropdownMenu) {
        // Manual dropdown toggle (always add as backup)
        dropdownElement.addEventListener('click', function(e) {
            console.log('Dropdown clicked');
            e.preventDefault();
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
            dropdownElement.setAttribute('aria-expanded', dropdownMenu.classList.contains('show'));
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownElement.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
                dropdownElement.setAttribute('aria-expanded', 'false');
            }
        });
    }
    
    // Update dropdown text on checkbox change
    document.querySelectorAll('.source-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateDropdownText);
    });
    
    // Prevent dropdown from closing when clicking on checkboxes
    document.querySelectorAll('.dropdown-item-text').forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Initial update
    updateDropdownText();
});

// URL Checker Form Handler
document.getElementById('urlCheckForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const csrftoken = getCookie('csrftoken');
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Check if at least one source is selected
    const selectedSources = this.querySelectorAll('input[name="sources"]:checked');
    if (selectedSources.length === 0) {
        alert('‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’®’∂’ø÷Ä’•’¨ ’°’º’∂’æ’°’¶’∂ ’¥’•’Ø ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ’°’≤’¢’µ’∏÷Ç÷Ä');
        return;
    }
    
    // Show loading state with selected sources count
    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß ${selectedSources.length} ’°’≤’¢’µ’∏÷Ç÷Ä’∏’æ...`;
    submitBtn.disabled = true;
    
    // Clear previous results
    document.getElementById('urlResult').innerHTML = `
        <div class="d-flex justify-content-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="ms-3">‘ø’°’ø’°÷Ä’æ’∏÷Ç’¥ ’ß URL-’´ ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ’Ω’ø’∏÷Ç’£’∏÷Ç’¥...</div>
        </div>
    `;

    fetch("{% url 'url_checker:check_url' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: new FormData(this)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        let alertClass = 'alert-warning';
        let iconClass = 'fa-question-circle';
        let statusColor = 'text-warning';
        let confidenceText = '';
        
        // Status based styling
        if (data.status === 'safe') {
            alertClass = 'alert-custom';
            iconClass = 'fa-shield-alt';
            statusColor = 'text-success';
        } else if (data.status === 'malicious') {
            alertClass = 'alert-error';
            iconClass = 'fa-exclamation-triangle';
            statusColor = 'text-danger';
        } else if (data.status === 'suspicious') {
            alertClass = 'alert-warning';
            iconClass = 'fa-exclamation-circle';
            statusColor = 'text-warning';
        } else if (data.status === 'pending') {
            alertClass = 'alert-primary';
            iconClass = 'fa-search';
            statusColor = 'text-primary';
        }

        // Confidence level indication
        switch(data.confidence) {
            case 'high':
                confidenceText = '<span class="badge bg-success ms-2">‘≤’°÷Ä’±÷Ä ’æ’Ω’ø’°’∞’∏÷Ç’©’µ’∏÷Ç’∂</span>';
                break;
            case 'medium':
                confidenceText = '<span class="badge bg-warning ms-2">’Ñ’´’ª’´’∂ ’æ’Ω’ø’°’∞’∏÷Ç’©’µ’∏÷Ç’∂</span>';
                break;
            case 'low':
                confidenceText = '<span class="badge bg-secondary ms-2">’ë’°’Æ÷Ä ’æ’Ω’ø’°’∞’∏÷Ç’©’µ’∏÷Ç’∂</span>';
                break;
        }

        // Sources used display
        let sourcesDisplay = '';
        if (data.sources_used && data.sources_used.length > 0) {
            sourcesDisplay = `
                <div class="mt-4 mb-3">
                    <p style="color: #000;"><strong style="color: #000;">’ï’£’ø’°’£’∏÷Ä’Æ’æ’°’Æ API-’∂’•÷Ä:</strong> ${data.sources_used.join(', ')}</p>
                </div>
            `;
        }
        
        // Manual review message check
        let manualReviewDisplay = '';
        if (data.manual_review_required || (data.internal_analysis && data.internal_analysis.manual_review_required) || data.status === 'pending') {
            // Use the review message if provided, otherwise use a default
            const reviewMessage = data.review_message || 
                                (data.internal_analysis && data.internal_analysis.review_message) || 
                                '‘±’µ’Ω URL-’® ’°’∂’∞’°’µ’ø ’ß ’¥’•÷Ä ’¢’°’¶’°’µ’∏÷Ç’¥: ’Ñ’•÷Ä ’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ’©’´’¥’® ’Ø’°’∂÷Å’Ø’°÷Å’∂’´ manual ’Ω’ø’∏÷Ç’£’∏÷Ç’¥ 5 ’°’∑’≠’°’ø’°’∂÷Ñ’°’µ’´’∂ ÷Ö÷Ä’æ’° ’®’∂’©’°÷Å÷Ñ’∏÷Ç’¥';
            manualReviewDisplay = `
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div>
                            <strong>Manual Review ‘ø’Ø’°’ø’°÷Ä’æ’´</strong>
                            <p class="mb-0 mt-1">${reviewMessage}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Force the status to show pending with manual review for UI consistency
            if (data.status === 'pending') {
                alertClass = 'alert-primary';
                iconClass = 'fa-search';
                statusColor = 'text-primary';
            }
        }

        document.getElementById('urlResult').innerHTML = `
            <div class="result-container">
                ${sourcesDisplay}
                ${manualReviewDisplay}
                ${data.result || '’â’Ø’° ’¨÷Ä’°÷Å’∏÷Ç÷Å’´’π ’ø’•’≤’•’Ø’∏÷Ç’©’µ’∏÷Ç’∂'}
            </div>
        `;
        
        // Update recent URLs list if the result is available
        const checkedUrl = document.getElementById('url_input').value;
        if (checkedUrl && !document.querySelector('#recentUrls p.checked-url[data-url="' + checkedUrl + '"]')) {
            try {
                updateRecentChecks(checkedUrl, data.status, data.status_display);
            } catch (error) {
                console.error('Error updating recent checks:', error);
                // Fallback if function is not available
                const recentUrlsContainer = document.getElementById('recentUrls');
                if (recentUrlsContainer) {
                    const urlElement = document.createElement('p');
                    urlElement.className = 'checked-url mb-2';
                    urlElement.setAttribute('data-url', checkedUrl);
                    urlElement.textContent = checkedUrl + ' - ' + (data.status_display || data.status);
                    recentUrlsContainer.insertBefore(urlElement, recentUrlsContainer.firstChild);
                }
            }
        }
        
        // Create pie chart if canvas exists
        setTimeout(() => {
            const canvas = document.getElementById('securityChart');
            if (canvas && data.source_statistics) {
                const ctx = canvas.getContext('2d');
                const stats = data.source_statistics;
                
                // Use actual statistics from the response
                const safeCount = stats.safe_sources || 0;
                const maliciousCount = stats.malicious_sources || 0;
                const suspiciousCount = stats.suspicious_sources || 0;
                const pendingCount = stats.pending_sources || 0;
                
                // Only show chart if there's data
                if (safeCount + maliciousCount + suspiciousCount + pendingCount > 0) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['‘±’∂’æ’ø’°’∂’£', '’é’ø’°’∂’£’°’æ’∏÷Ä', '‘ø’°’Ω’Ø’°’Æ’•’¨’´', '’ç’∫’°’Ω’∏÷Ç’¥'],
                            datasets: [{
                                data: [safeCount, maliciousCount, suspiciousCount, pendingCount],
                                backgroundColor: [
                                    '#198754', // success - green
                                    '#dc3545', // danger - red
                                    '#ffc107', // warning - yellow
                                    '#0dcaf0'  // info - cyan
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff',
                                hoverBorderWidth: 3,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((value / total) * 100);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '50%',
                            elements: {
                                arc: {
                                    borderRadius: 3
                                }
                            }
                        }
                    });
                } else {
                    // Hide chart container if no data
                    canvas.closest('.card').style.display = 'none';
                }
            }
        }, 100);
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('urlResult').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-times-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="mb-1">’ç’≠’°’¨ ’ß ’ø’•’≤’´ ’∏÷Ç’∂’•÷Å’•’¨ URL-’´ ’Ω’ø’∏÷Ç’£’¥’°’∂ ’™’°’¥’°’∂’°’Ø</h5>
                        <p class="mb-0">‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’Ø÷Ä’Ø’´’∂ ÷É’∏÷Ä’±’•’¨ ’Ø’°’¥ ’Ω’ø’∏÷Ç’£’•’¨ ’°’µ’¨ URL:</p>
                        <p class="mb-0 mt-2"><small class="text-muted">’è’•’≠’∂’´’Ø’°’Ø’°’∂ ’Ω’≠’°’¨: ${error.message}</small></p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="’ì’°’Ø’•’¨"></button>
            </div>
        `;
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Email Checker Form Handler (Placeholder for future integration)
document.getElementById('emailCheckForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    const emailInput = this.querySelector('#email_input').value;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß...';
    submitBtn.disabled = true;

    // Simulate processing for now
    setTimeout(() => {
        document.getElementById('emailResult').innerHTML = `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                    <div>
                        <h6 class="alert-heading mb-1">‘∑’¨. ÷É’∏’Ω’ø’´ ’ç’ø’∏÷Ç’£’∏÷Ç’¥</h6>
                        <p class="mb-1"><strong>’Ä’°’Ω÷Å’•:</strong> ${emailInput}</p>
                        <p class="mb-0"><strong>‘ø’°÷Ä’£’°’æ’´’≥’°’Ø:</strong> ‘∑’¨. ÷É’∏’Ω’ø’´ ’Ω’ø’∏÷Ç’£’´’π’® ’¥’∑’°’Ø’¥’°’∂ ÷É’∏÷Ç’¨’∏÷Ç’¥ ’ß÷â ’á’∏÷Ç’ø’∏’æ ’Ø’°’æ’•’¨’°÷Å’æ’•’∂ ’∂’∏÷Ä ’´’∂’ø’•’£÷Ä’°÷Å’´’°’∂’•÷Ä ÷Ü’´’∑’´’∂’£’°’µ’´’∂ ÷á ’æ’ø’°’∂’£’°’æ’∏÷Ä ’ß’¨. ÷É’∏’Ω’ø’•÷Ä’´ ’∞’°’µ’ø’∂’°’¢’•÷Ä’¥’°’∂ ’∞’°’¥’°÷Ä÷â</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="’ì’°’Ø’•’¨"></button>
            </div>
        `;
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 2000);
});

// Ensure all JavaScript functions are available
document.addEventListener('DOMContentLoaded', function() {
    // Check if url_checker.js functions are loaded
    if (typeof updateRecentChecks !== 'function') {
        console.error('URL Checker functions not loaded. Loading fallback implementation.');
        
        // Fallback implementation
        window.updateRecentChecks = function(url, status, statusDisplay) {
            console.log('Using fallback updateRecentChecks function');
            const recentUrlsContainer = document.getElementById('recentUrls');
            if (!recentUrlsContainer) return;
            
            // Clear the initial message if it exists
            if (recentUrlsContainer.querySelector('p:not(.checked-url)')) {
                recentUrlsContainer.innerHTML = '';
            }
            
            // Create a new URL entry element
            const urlElement = document.createElement('p');
            urlElement.className = 'checked-url mb-2';
            urlElement.setAttribute('data-url', url);
            urlElement.textContent = url + ' - ' + (statusDisplay || status);
            
            // Add to the container (at the beginning)
            recentUrlsContainer.insertBefore(urlElement, recentUrlsContainer.firstChild);
            
            // Limit to 5 recent URLs
            const allUrls = recentUrlsContainer.querySelectorAll('.checked-url');
            if (allUrls.length > 5) {
                recentUrlsContainer.removeChild(allUrls[allUrls.length - 1]);
            }
        };
        
        window.fillUrlInput = function(url) {
            const urlInput = document.getElementById('url_input');
            if (urlInput) {
                urlInput.value = url;
                urlInput.focus();
            }
        };
    }
});
</script>

<style>
/* URL Analysis Result Styles */
.url-analysis-result {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.url-analysis-result .card {
    transition: all 0.3s ease;
}

.url-analysis-result .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.url-analysis-result .progress {
    border-radius: 10px;
    overflow: hidden;
}

.url-analysis-result .progress-bar {
    transition: width 0.6s ease;
}

.url-analysis-result .badge {
    font-weight: 500;
    letter-spacing: 0.5px;
}

.url-analysis-result .alert {
    border-radius: 12px;
}

.url-analysis-result .accordion-button {
    font-weight: 500;
    border-radius: 8px !important;
}

.url-analysis-result .accordion-button:not(.collapsed) {
    background-color: var(--bs-primary);
    color: white;
}

.url-analysis-result code {
    font-size: 0.9em;
    word-break: break-all;
}

/* Source Selection Styles - Dropdown */
.dropdown-menu {
    max-height: 250px !important;
    overflow-y: auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    background-color: white !important;
    position: absolute !important;
    z-index: 1050 !important;
}

.dropdown-item-text {
    padding: 0.5rem 0;
    color: black !important;
}

.dropdown-item-text .form-check {
    margin-bottom: 0;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.dropdown-item-text .form-check:hover {
    background-color: rgba(0,0,0,0.05);
}

.dropdown-item-text .form-check-input:disabled + .form-check-label {
    opacity: 0.6;
}

.dropdown-item-text .form-check-label {
    color: black !important;
}

.dropdown-item-text .form-check-label strong {
    color: black !important;
}

.dropdown-item-text .form-check-label .text-muted {
    color: #6c757d !important;
}

/* Custom scrollbar for dropdown */
.dropdown-menu::-webkit-scrollbar {
    width: 6px;
}

.dropdown-menu::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.dropdown-menu::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.dropdown-toggle {
    min-height: 50px;
    padding: 12px 16px;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
    background-color: white !important;
    color: black !important;
}

.dropdown-toggle:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    background-color: white !important;
    color: black !important;
}

.dropdown-toggle:hover {
    background-color: white !important;
    color: black !important;
}

.dropdown-divider {
    margin: 0.25rem 0;
}

.form-check-inline.opacity-75 {
    cursor: not-allowed;
}

.sources-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 0.75rem;
}

.source-api-section {
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 123, 255, 0.1);
    transition: all 0.3s ease;
}

.source-api-section:hover {
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
    transform: translateY(-2px);
}

.source-api-section .badge {
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.source-api-section .badge:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
}

/* Light theme colors */
.bg-light-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.bg-light-danger {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

.bg-light-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.bg-light-info {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

/* Result container */
.result-container {
    margin-top: 1rem;
    border-radius: 12px;
    overflow: hidden;
}

/* Animation for result appearance */
.result-container {
    animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Source badges animation */
.sources-info .badge {
    animation: fadeInScale 0.3s ease-out;
    animation-fill-mode: both;
}

.sources-info .badge:nth-child(1) { animation-delay: 0.1s; }
.sources-info .badge:nth-child(2) { animation-delay: 0.2s; }
.sources-info .badge:nth-child(3) { animation-delay: 0.3s; }

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .url-analysis-result .card-body {
        padding: 1rem 0.75rem;
    }
    
    .url-analysis-result .alert {
        padding: 1rem;
    }
    
    .url-analysis-result h5 {
        font-size: 1.1rem;
    }
    
    .url-analysis-result h6 {
        font-size: 1rem;
    }
    
    .form-check-inline {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}